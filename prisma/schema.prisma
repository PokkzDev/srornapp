// ================================
// DATASOURCE & GENERATOR
// ================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ================================
// ENUMS DE SOPORTE CLÍNICO
// ================================
enum TipoParto {
  VAGINAL
  INSTRUMENTAL
  CESAREA_ELECTIVA
  CESAREA_URGENCIA
  PREHOSPITALARIO          // parto prehospitalario (ambulancia/establecimiento)
  FUERA_RED                // fuera de la red de salud
  DOMICILIO_PROFESIONAL
  DOMICILIO_SIN_PROFESIONAL
}

enum LugarParto {
  SALA_PARTO
  PABELLON
  DOMICILIO
  OTRO
}

enum SexoRN {
  M
  F
  I
}

enum Sexo {
  M
  F
  INTERSEX
  NO_REGISTRA
}

enum CursoParto {
  EUTOCICO
  DISTOCICO
}

enum InicioTrabajoParto {
  ESPONTANEO
  INDUCIDO_MECANICO
  INDUCIDO_FARMACOLOGICO
}

enum PosicionExpulsivo {
  LITOTOMIA
  OTRAS
}

enum CategoriaPeso {
  MENOR_500
  RANGO_500_999
  RANGO_1000_1499
  RANGO_1500_1999
  RANGO_2000_2499
  RANGO_2500_2999
  RANGO_3000_3999
  RANGO_4000_MAS
}

enum TipoComplicacion {
  HPP_INERCIA
  HPP_RESTOS
  HPP_TRAUMA
  DESGARROS_III_IV
  ALTERACION_COAGULACION
  PREECLAMPSIA_SEVERA
  ECLAMPSIA
  SEPSIS_SISTEMICA_GRAVE
  MANEJO_QUIRURGICO_INERCIA
  HISTERCTOMIA_OBSTETRICA
  ANEMIA_SEVERA_TRANSFUSION
}

enum ContextoComplicacion {
  PARTO_ESPONTANEO_INSTITUCIONAL
  PARTO_INDUCIDO_INSTITUCIONAL
  CESAREA_URGENCIA
  CESAREA_ELECTIVA
  PARTO_DOMICILIO
  EUTOCICO_ESPONTANEO
  EUTOCICO_INDUCIDO
  DISTOCICO_ESPONTANEO
  DISTOCICO_INDUCIDO
}

enum TipoEsterilizacion {
  LIGADURA_TUBARIA
  VASECTOMIA
  OTRO
}

enum EstadoEpisodio {
  INGRESADO
  ALTA
}

enum TipoControlNeonatal {
  SIGNOS_VITALES
  GLUCEMIA
  ALIMENTACION
  MEDICACION
  OTRO
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  EXPORT
  PERMISSION_DENIED
}

enum ServicioUnidad {
  URNI
  UCIN
  NEONATOLOGIA
}

// ================================
// MODELO: USER (RBAC)
// ================================
model User {
  id           String   @id @default(uuid()) @db.Char(36)
  rut          String?  @unique @db.VarChar(191)
  nombre       String   @db.VarChar(191)
  email        String   @unique @db.VarChar(191)
  passwordHash String   @db.VarChar(191)
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // RBAC Relations
  roles       UserRole[]
  permissions UserPermission[]

  // Reverse relations - Clinical models
  madresCreated               Madre[]           @relation("MadreCreatedBy")
  madresUpdated               Madre[]           @relation("MadreUpdatedBy")
  partosMatrona               PartoMatrona[]
  partosMedico                PartoMedico[]
  partosEnfermera             PartoEnfermera[]
  partosCreated               Parto[]           @relation("PartoCreatedBy")
  partosUpdated               Parto[]           @relation("PartoUpdatedBy")
  recienNacidosCreated        RecienNacido[]    @relation("RNCreatedBy")
  recienNacidosUpdated        RecienNacido[]    @relation("RNUpdatedBy")
  episodiosCreated            EpisodioURNI[]    @relation("EpisodioCreatedBy")
  episodiosUpdated            EpisodioURNI[]    @relation("EpisodioUpdatedBy")
  episodiosResponsableClinico EpisodioURNI[]    @relation("EpisodioResponsableClinico")
  episodiosMadreCreated       EpisodioMadre[]   @relation("EpisodioMadreCreatedBy")
  episodiosMadreUpdated       EpisodioMadre[]   @relation("EpisodioMadreUpdatedBy")
  atencionesMedico            AtencionURNI[]    @relation("AtencionMedico")
  controlesEnfermera          ControlNeonatal[] @relation("ControlEnfermera")
  reportesREM                 ReporteREM[]      @relation("REMGeneradoPor")
  informesAlta                InformeAlta[]     @relation("InformeAltaGeneradoPor")
  auditorias                  Auditoria[]       @relation("AuditoriaUsuario")

  @@index([email])
}

// ================================
// MODELO: ROLE (RBAC)
// ================================
model Role {
  id          String  @id @default(uuid()) @db.Char(36)
  name        String  @unique @db.VarChar(191)
  description String? @db.VarChar(191)
  isSystem    Boolean @default(false)

  users       UserRole[]
  permissions RolePermission[]

  @@map("Role")
}

// ================================
// MODELO: PERMISSION (RBAC)
// ================================
model Permission {
  id          String  @id @default(uuid()) @db.Char(36)
  code        String  @unique @db.VarChar(191)
  description String? @db.VarChar(191)

  roles RolePermission[]
  users UserPermission[]

  @@map("Permission")
}

// ================================
// MODELO: USER_ROLE
// ================================
model UserRole {
  userId    String   @db.Char(36)
  roleId    String   @db.Char(36)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("UserRole")
}

// ================================
// MODELO: ROLE_PERMISSION
// ================================
model RolePermission {
  roleId       String     @db.Char(36)
  permissionId String     @db.Char(36)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("RolePermission")
}

// ================================
// MODELO: USER_PERMISSION
// ================================
model UserPermission {
  userId       String     @db.Char(36)
  permissionId String     @db.Char(36)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@id([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@map("UserPermission")
}

// ================================
// MODELO: MADRE
// ================================
model Madre {
  id String @id @default(uuid()) @db.Char(36)

  // Identificación
  rut       String @unique @db.VarChar(12) // sin puntos, con guion
  nombres   String @db.VarChar(120)
  apellidos String @db.VarChar(120)

  // Demográficos
  edad            Int?
  edadAnos        Int?               // edad en años para tramos REM
  fechaNacimiento DateTime?
  direccion       String?  @db.VarChar(200)
  telefono        String?  @db.VarChar(20)
  fichaClinica    String?  @unique @db.VarChar(30)

  // Campos REM
  pertenenciaPuebloOriginario Boolean?
  condicionMigrante           Boolean?
  condicionDiscapacidad       Boolean?
  condicionPrivadaLibertad    Boolean?
  identidadTrans              Boolean?
  hepatitisBPositiva          Boolean?
  controlPrenatal             Boolean?

  // Relación con partos
  partos Parto[]

  // Episodios
  episodios EpisodioMadre[]

  // Metadatos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Trazabilidad
  createdById String? @db.Char(36)
  updatedById String? @db.Char(36)
  createdBy   User?   @relation("MadreCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy   User?   @relation("MadreUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([rut])
  @@index([fichaClinica])
  @@index([apellidos, nombres])
}

// ================================
// MODELO: PARTO
// ================================
model Parto {
  id String @id @default(uuid()) @db.Char(36)

  madreId String @db.Char(36)
  madre   Madre  @relation(fields: [madreId], references: [id], onDelete: Restrict)

  // Datos del evento
  fechaHora     DateTime
  fechaParto    DateTime?
  tipo          TipoParto
  lugar         LugarParto
  lugarDetalle  String? @db.VarChar(120)
  complicacionesTexto String? @db.VarChar(500)
  observaciones  String? @db.VarChar(500)

  // REM - características del parto
  establecimientoId      String?
  edadGestacionalSemanas Int?

  // Curso del parto
  tipoCursoParto CursoParto?

  // Modelo de atención
  inicioTrabajoParto         InicioTrabajoParto?
  conduccionOxitocica        Boolean?
  libertadMovimiento         Boolean?
  regimenHidricoAmplio       Boolean?
  manejoDolorNoFarmacologico Boolean?
  manejoDolorFarmacologico   Boolean?
  posicionExpulsivo          PosicionExpulsivo?
  episiotomia                Boolean?

  // Anestesia y/o Analgesia del parto
  anestesiaNeuroaxial              Boolean?
  oxidoNitroso                     Boolean?
  analgesiaEndovenosa              Boolean?
  anestesiaGeneral                 Boolean?
  anestesiaLocal                   Boolean?
  medidasNoFarmacologicasAnestesia Boolean?

  // Acompañamiento
  acompananteDuranteTrabajo Boolean?
  acompananteSoloExpulsivo  Boolean?

  // Buenas prácticas
  oxitocinaProfilactica       Boolean?
  ligaduraTardiaCordon        Boolean?
  atencionPertinenciaCultural Boolean?
  contactoPielPielMadre30min  Boolean?
  contactoPielPielAcomp30min  Boolean?

  // Lactancia temprana (si ≥1 RN elegible la recibe)
  lactancia60minAlMenosUnRn Boolean?

  // Campos adicionales REM
  planDeParto                Boolean?
  entregaPlacentaSolicitud    Boolean?
  embarazoNoControlado        Boolean?

  // Profesionales
  matronas   PartoMatrona[]
  medicos    PartoMedico[]
  enfermeras PartoEnfermera[]

  // RN
  recienNacidos RecienNacido[]

  // Informes de alta
  informesAlta InformeAlta[]

  // REM relaciones
  complicaciones             ComplicacionObstetrica[]
  esterilizacionesVinculadas EsterilizacionQuirurgica[]

  // Metadatos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Trazabilidad
  createdById String? @db.Char(36)
  updatedById String? @db.Char(36)
  createdBy   User?   @relation("PartoCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy   User?   @relation("PartoUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([madreId])
  @@index([fechaHora])
  @@index([tipo])
  @@index([lugar])
}

// ================================
// M2M PROFESIONALES
// ================================
model PartoMatrona {
  partoId  String @db.Char(36)
  userId   String @db.Char(36)
  parto    Parto  @relation(fields: [partoId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([partoId, userId])
  @@index([partoId])
  @@index([userId])
  @@map("PartoMatrona")
}

model PartoMedico {
  partoId  String @db.Char(36)
  userId   String @db.Char(36)
  parto    Parto  @relation(fields: [partoId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([partoId, userId])
  @@index([partoId])
  @@index([userId])
  @@map("PartoMedico")
}

model PartoEnfermera {
  partoId  String @db.Char(36)
  userId   String @db.Char(36)
  parto    Parto  @relation(fields: [partoId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([partoId, userId])
  @@index([partoId])
  @@index([userId])
  @@map("PartoEnfermera")
}

// ================================
// MODELO: RECIÉN NACIDO
// ================================
model RecienNacido {
  id String @id @default(uuid()) @db.Char(36)

  partoId String @db.Char(36)
  parto   Parto  @relation(fields: [partoId], references: [id], onDelete: Restrict)

  sexo                 SexoRN
  pesoNacimientoGramos Int?
  tallaCm              Int?
  apgar1Min            Int?
  apgar5Min            Int?
  observaciones        String? @db.VarChar(500)

  // REM
  esNacidoVivo  Boolean       @default(true)
  categoriaPeso CategoriaPeso?

  // Anomalías congénitas
  anomaliaCongenita            Boolean?
  anomaliaCongenitaDescripcion String? @db.VarChar(500)

  // Reanimación y EHI
  reanimacionBasica  Boolean?
  reanimacionAvanzada Boolean?
  ehiGradoII_III     Boolean?

  // Profilaxis inmediata
  profilaxisOcularGonorrea     Boolean?
  profilaxisHepatitisB         Boolean?
  profilaxisCompletaHepatitisB Boolean?

  // Transmisión vertical Hep B
  hijoMadreHepatitisBPositiva Boolean?

  // Lactancia / contacto / alojamiento
  lactancia60Min               Boolean?
  alojamientoConjuntoInmediato Boolean?
  contactoPielPielInmediato    Boolean?

  // Condición étnica/migrante
  esPuebloOriginario Boolean?
  esMigrante         Boolean?

  // URNI / Neonatal
  episodios  EpisodioURNI[]
  controles  ControlNeonatal[]
  atenciones AtencionURNI[]

  // Metadatos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Trazabilidad
  createdById String? @db.Char(36)
  updatedById String? @db.Char(36)
  createdBy   User?   @relation("RNCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy   User?   @relation("RNUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([partoId])
  @@index([sexo])
}

// ================================
// MODELO: COMPLICACIONES OBSTÉTRICAS
// ================================
model ComplicacionObstetrica {
  id                  String               @id @default(uuid()) @db.Char(36)
  partoId             String
  parto               Parto                @relation(fields: [partoId], references: [id], onDelete: Restrict)
  tipo                TipoComplicacion
  contexto            ContextoComplicacion?
  requiereTransfusion Boolean?
  fechaComplicacion   DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([partoId])
  @@index([tipo])
  @@index([fechaComplicacion])
}

// ================================
// MODELO: ESTERILIZACIONES QUIRÚRGICAS
// ================================
model EsterilizacionQuirurgica {
  id                 String   @id @default(uuid()) @db.Char(36)
  fecha              DateTime
  sexo               Sexo
  edadAnos           Int
  tipo               TipoEsterilizacion?
  condicionTrans     Boolean?
  esPuebloOriginario Boolean?
  esMigrante         Boolean?

  vinculoConParto Boolean?
  partoId         String?  @db.Char(36)
  parto           Parto?   @relation(fields: [partoId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([partoId])
  @@index([fecha])
  @@index([sexo])
  @@index([tipo])
}

// ================================
// MODELO: EPISODIO MADRE
// ================================
model EpisodioMadre {
  id String @id @default(uuid()) @db.Char(36)

  madreId String @db.Char(36)
  madre   Madre  @relation(fields: [madreId], references: [id], onDelete: Restrict)

  estado          EstadoEpisodio @default(INGRESADO)
  fechaIngreso    DateTime
  motivoIngreso   String?        @db.VarChar(300)
  hospitalAnterior String?       @db.VarChar(200)

  fechaAlta       DateTime?
  condicionEgreso String?        @db.VarChar(300)

  informeAlta InformeAlta?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String? @db.Char(36)
  updatedById String? @db.Char(36)
  createdBy   User?   @relation("EpisodioMadreCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy   User?   @relation("EpisodioMadreUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([madreId])
  @@index([estado])
  @@index([fechaIngreso])
  @@map("EpisodioMadre")
}

// ================================
// MODELO: EPISODIO URNI
// ================================
model EpisodioURNI {
  id String @id @default(uuid()) @db.Char(36)

  rnId String       @db.Char(36)
  rn   RecienNacido @relation(fields: [rnId], references: [id], onDelete: Restrict)

  estado             EstadoEpisodio @default(INGRESADO)
  fechaHoraIngreso   DateTime
  motivoIngreso      String?        @db.VarChar(300)
  servicioUnidad     ServicioUnidad?
  responsableClinicoId String?      @db.Char(36)
  responsableClinico   User?        @relation("EpisodioResponsableClinico", fields: [responsableClinicoId], references: [id], onDelete: SetNull)

  fechaHoraAlta   DateTime?
  condicionEgreso String?   @db.VarChar(300)

  atenciones AtencionURNI[] @relation("EpisodioAtenciones")
  controles  ControlNeonatal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String? @db.Char(36)
  updatedById String? @db.Char(36)
  createdBy   User?   @relation("EpisodioCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy   User?   @relation("EpisodioUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([rnId])
  @@index([estado])
  @@index([fechaHoraIngreso])
  @@index([responsableClinicoId])
}

// ================================
// MODELO: ATENCIÓN URNI
// ================================
model AtencionURNI {
  id String @id @default(uuid()) @db.Char(36)

  rnId String       @db.Char(36)
  rn   RecienNacido @relation(fields: [rnId], references: [id], onDelete: Restrict)

  episodioId String?       @db.Char(36)
  episodio   EpisodioURNI? @relation("EpisodioAtenciones", fields: [episodioId], references: [id], onDelete: SetNull)

  fechaHora    DateTime @default(now())
  diagnostico  String?  @db.VarChar(500)
  indicaciones String?  @db.VarChar(800)
  evolucion    String?  @db.VarChar(1000)

  medicoId String? @db.Char(36)
  medico   User?   @relation("AtencionMedico", fields: [medicoId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rnId])
  @@index([episodioId])
  @@index([fechaHora])
}

// ================================
// MODELO: CONTROL NEONATAL
// ================================
model ControlNeonatal {
  id String @id @default(uuid()) @db.Char(36)

  rnId String       @db.Char(36)
  rn   RecienNacido @relation(fields: [rnId], references: [id], onDelete: Restrict)

  episodioUrniId String?       @db.Char(36)
  episodioUrni   EpisodioURNI? @relation(fields: [episodioUrniId], references: [id], onDelete: SetNull)

  fechaHora     DateTime            @default(now())
  tipo          TipoControlNeonatal @default(SIGNOS_VITALES)
  datos         Json?
  observaciones String?             @db.VarChar(500)

  enfermeraId String? @db.Char(36)
  enfermera   User?   @relation("ControlEnfermera", fields: [enfermeraId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rnId])
  @@index([episodioUrniId])
  @@index([fechaHora])
  @@index([tipo])
}

// ================================
// MODELO: REPORTE REM
// ================================
model ReporteREM {
  id String @id @default(uuid()) @db.Char(36)

  periodo    String @db.VarChar(7) // YYYY-MM
  jsonFuente Json
  totales    Json

  generadoPorId String?  @db.Char(36)
  generadoPor   User?    @relation("REMGeneradoPor", fields: [generadoPorId], references: [id], onDelete: SetNull)
  generadoAt    DateTime @default(now())

  @@index([periodo])
}

// ================================
// MODELO: INFORME ALTA
// ================================
model InformeAlta {
  id String @id @default(uuid()) @db.Char(36)

  partoId String @db.Char(36)
  parto   Parto  @relation(fields: [partoId], references: [id], onDelete: Restrict)

  episodioId String        @unique @db.Char(36)
  episodio   EpisodioMadre @relation(fields: [episodioId], references: [id], onDelete: Restrict)

  fechaGeneracion DateTime @default(now())
  formato         String   @db.VarChar(10)

  generadoPorId String? @db.Char(36)
  generadoPor   User?   @relation("InformeAltaGeneradoPor", fields: [generadoPorId], references: [id], onDelete: SetNull)

  contenido Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([partoId])
  @@index([episodioId])
  @@index([fechaGeneracion])
  @@index([generadoPorId])
  @@map("InformeAlta")
}

// ================================
// MODELO: AUDITORÍA
// ================================
model Auditoria {
  id        String   @id @default(uuid()) @db.Char(36)
  fechaHora DateTime @default(now())

  usuarioId String? @db.Char(36)
  usuario   User?   @relation("AuditoriaUsuario", fields: [usuarioId], references: [id], onDelete: SetNull)
  rol       String? @db.VarChar(40)

  entidad       String      @db.VarChar(80)
  entidadId     String?     @db.VarChar(36)
  accion        AuditAction
  detalleBefore Json?
  detalleAfter  Json?

  ip        String? @db.VarChar(45)
  userAgent String? @db.VarChar(255)

  @@index([fechaHora])
  @@index([entidad, entidadId])
  @@index([usuarioId])
}
